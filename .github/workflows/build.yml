name: Build Project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        local-cache: true

    - name: Set environment variables
      run: |
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git

    - name: Download Dobby
      run: |
        mkdir -p jni/external
        if [ ! -f "jni/external/libdobby.a" ]; then
          echo "Dobby library not found, cloning repository..."
          git clone --depth=1 https://github.com/jmpews/Dobby.git jni/external/Dobby
        else
          echo "Dobby library already exists"
        fi

    - name: Build Dobby
      run: |
        cd jni/external/Dobby
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21
        make -j$(nproc)
        
        # Copy the built library to the expected location
        mkdir -p ../../../libs/arm64-v8a/
        cp libdob.a ../../../libs/arm64-v8a/libdobby.a || echo "Could not find built library"
        
        # Also copy to the location expected by the build script
        cd ../..
        if [ -f "build/lib/libdobby.a" ]; then
          cp build/lib/libdobby.a .
        elif [ -f "build/lib/arm64-v8a/libdobby.a" ]; then
          cp build/lib/arm64-v8a/libdobby.a .
        fi

    - name: Build Project
      run: |
        chmod +x build.sh
        ./build.sh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: built-module
        path: jni/libs/